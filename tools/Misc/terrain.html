<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Advanced STK Mission Simulation</title>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>
<body>
<canvas id="renderCanvas" style="width:100%; height:100vh;"></canvas>
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

const createScene = () => {
    const scene = new BABYLON.Scene(engine);

    // Camera
    const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI/2, Math.PI/4, 10000, BABYLON.Vector3.Zero(), scene);
    camera.attachControl(canvas, true);

    // Light
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

    // Earth
    const earth = BABYLON.MeshBuilder.CreateSphere("earth", {diameter: 12742}, scene);
    const earthMat = new BABYLON.StandardMaterial("earthMat", scene);
    earthMat.diffuseTexture = new BABYLON.Texture("https://www.solarsystemscope.com/textures/download/2k_earth_daymap.jpg", scene);
    earth.material = earthMat;

    // Satellite
    const satellite = BABYLON.MeshBuilder.CreateSphere("sat", {diameter: 100}, scene);
    satellite.position = new BABYLON.Vector3(6771,0,0); // 400 km orbit approx

    // Docking target (space station)
    const station = BABYLON.MeshBuilder.CreateBox("station", {size:200}, scene);
    station.position = new BABYLON.Vector3(6771,500,0);

    // Sensor coverage cone
    const sensorCone = BABYLON.MeshBuilder.CreateCylinder("cone", {diameterTop:0, diameterBottom:500, height:800, tessellation:32}, scene);
    sensorCone.position = satellite.position.clone();
    sensorCone.rotation.x = Math.PI/2;
    sensorCone.material = new BABYLON.StandardMaterial("coneMat", scene);
    sensorCone.material.alpha = 0.3;
    sensorCone.material.diffuseColor = new BABYLON.Color3(0,1,0);

    // Trajectory line
    const trajectoryPoints = [];
    const mu = 398600.4418; // Earth's standard gravitational parameter km^3/s^2
    let r = 6771;
    let theta = 0;
    for(let i=0; i<360; i++){
        theta += Math.PI/180;
        let x = r * Math.cos(theta);
        let y = r * Math.sin(theta);
        trajectoryPoints.push(new BABYLON.Vector3(x,y,0));
    }
    const trajectory = BABYLON.MeshBuilder.CreateLines("traj", {points: trajectoryPoints, updatable: true}, scene);
    trajectory.color = new BABYLON.Color3(1,0,0);

    // Simple orbit propagation
    let angle = 0;
    scene.onBeforeRenderObservable.add(()=>{
        angle += 0.01;
        let x = r * Math.cos(angle);
        let y = r * Math.sin(angle);
        satellite.position = new BABYLON.Vector3(x,y,0);
        sensorCone.position = satellite.position.clone();

        // Check docking proximity
        if(BABYLON.Vector3.Distance(satellite.position, station.position) < 200){
            console.log("Docking possible!");
        }
    });

    return scene;
};

const scene = createScene();
engine.runRenderLoop(()=>{
    scene.render();
});

window.addEventListener("resize", ()=>{
    engine.resize();
});
</script>
</body>
</html>